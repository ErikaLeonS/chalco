<!DOCTYPE html>
<html>
<head>
    <title>Mapa con Fotos en Leaflet</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Incluye el CSS de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 600px; }

        /* Estilo de popup naranja */
        .popup-naranja {
            background-color: orange;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }

        /* Estilo para GeoJSON */
        .geojson-area {
            color: blue; /* Color de borde */
            fillColor: cyan; /* Color de relleno */
            fillOpacity: 0.5; /* Opacidad del relleno */
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Incluye el JavaScript de Leaflet y EXIF.js -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
        // Inicializa el mapa centrado en Chalco, Estado de México
        var map = L.map('map').setView([19.2647, -98.8972], 13); // Coordenadas de Chalco con zoom 13

        // Añade una capa de mapas de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);

        // Crear capas de grupo vacías para fotos y GeoJSON
        var capaRecorrido2308 = L.layerGroup();
        var capaRecorrido2708 = L.layerGroup();
        var capaInundacion = L.layerGroup();

        // Rutas de las carpetas de fotos en GitHub
        var fotosCarpeta1 = 'https://raw.githubusercontent.com/ErikaLeonS/chalco/main/fotos_rec_23082024/';
        var fotosCarpeta2 = 'https://raw.githubusercontent.com/ErikaLeonS/chalco/main/fotos_rec_27082024/';

        // Número total de fotos en cada carpeta
        var totalFotos1 = 148;
        var totalFotos2 = 100; // Cambia este valor según el número real de fotos en la segunda carpeta

        // Definir un icono de marcador naranja personalizado
        var iconoNaranja = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png', // Usa la URL de un icono base
            iconSize: [25, 41], // Tamaño del icono
            iconAnchor: [12, 41], // Punto de anclaje del icono
            popupAnchor: [1, -34], // Punto de anclaje del popup
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png', // Sombra del icono
            shadowSize: [41, 41],
            className: 'marker-naranja' // Clase CSS para el color naranja
        });

        // Función para convertir grados, minutos y segundos a decimal
        function convertirDMSToDD(grados, minutos, segundos, direccion) {
            var dd = grados + minutos/60 + segundos/(60*60);
            if (direccion == "S" || direccion == "W") {
                dd = dd * -1; 
            }
            return dd;
        }

        // Función para reemplazar espacios en nombres de archivos
        function encodeFileName(fileName) {
            return fileName.replace(/ /g, '%20');
        }

        // Función de depuración para verificar la URL
        function verificarURL(fotoUrl) {
            var img = new Image();
            img.src = fotoUrl;

            img.onload = function() {
                console.log('Foto cargada correctamente:', fotoUrl);
            };

            img.onerror = function() {
                console.error('Error al cargar la foto:', fotoUrl);
            };
        }

        // Función para cargar fotos y agregar marcadores al mapa
        function cargarFotos(fotosCarpeta, totalFotos, popupClase, iconoPersonalizado, capa) {
            for (var num = 1; num <= totalFotos; num++) { // Itera sobre todas las fotos
                (function(num) { // Usamos una IIFE para capturar el valor de 'num'
                    var fotoNombre = '1 (' + num + ').jpg'; // Construye el nombre de archivo
                    var fotoUrl = fotosCarpeta + encodeFileName(fotoNombre); // Codifica los espacios en la URL
                    verificarURL(fotoUrl); // Verifica cada URL generada

                    var img = new Image();
                    img.src = fotoUrl;

                    img.onload = function() {
                        EXIF.getData(img, function() {
                            var latitud = EXIF.getTag(this, "GPSLatitude");
                            var latitudRef = EXIF.getTag(this, "GPSLatitudeRef");
                            var longitud = EXIF.getTag(this, "GPSLongitude");
                            var longitudRef = EXIF.getTag(this, "GPSLongitudeRef");

                            if (latitud && longitud) {
                                var lat = convertirDMSToDD(latitud[0], latitud[1], latitud[2], latitudRef);
                                var lon = convertirDMSToDD(longitud[0], longitud[1], longitud[2], longitudRef);
                                
                                // Añadir marcador al mapa con icono personalizado si se proporciona
                                var marker = L.marker([lat, lon], { icon: iconoPersonalizado }).addTo(capa);
                                marker.bindPopup('<div class="' + popupClase + '"><img src="' + fotoUrl + '" width="150" height="150"/></div>');
                            } else {
                                console.error('No se encontraron datos GPS en:', fotoUrl);
                            }
                        });
                    };

                    img.onerror = function() {
                        console.error('Error al cargar la foto:', fotoUrl);
                    };
                })(num); // IIFE para capturar el valor actual de 'num'
            }
        }

        // Cargar fotos de la primera carpeta en su respectiva capa de grupo
        cargarFotos(fotosCarpeta1, totalFotos1, '', L.Icon.Default(), capaRecorrido2308);

        // Cargar fotos de la segunda carpeta en su respectiva capa de grupo
        cargarFotos(fotosCarpeta2, totalFotos2, 'popup-naranja', iconoNaranja, capaRecorrido2708);

        // Cargar el GeoJSON y agregarlo a la capa de grupo de inundación
        fetch('https://raw.githubusercontent.com/ErikaLeonS/chalco/main/inundacion.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: function (feature) {
                        return {
                            color: "blue",
                            fillColor: "cyan",
                            fillOpacity: 0.5,
                            weight: 2
                        };
                    },
                    onEachFeature: function (feature, layer) {
                        if (feature.properties && feature.properties.name) {
                            layer.bindPopup("<b>" + feature.properties.name + "</b>");
                        }
                    }
                }).addTo(capaInundacion);
            })
            .catch(error => console.error('Error al cargar el archivo GeoJSON:', error));

        // Crear el control de capas
        var capas = {
            "Recorrido 23 de agosto de 2024": capaRecorrido2308,
            "Recorrido 27 de agosto de 2024": capaRecorrido2708,
            "Inundación": capaInundacion
        };

        // Agregar el control de capas al mapa
        L.control.layers(null, capas).addTo(map);
    </script>
</body>
</html>
